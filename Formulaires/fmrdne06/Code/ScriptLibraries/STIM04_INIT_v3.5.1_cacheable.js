// jQuery$(document).ready(function() {	// Définition des textareas redimentionnables	$("textarea").addClass("ui-widget-content").resizable({ handles: "s", minHeight: 50 }); 	// Ajout des ressources existante	if((STIM04 !== undefined) && (STIM04.ressources !== undefined) && (STIM04.ressources.length > 0)) {		for(var i = 0, j = STIM04.ressources.length; i < j; i++) {			STIM04_Ressource_Append(STIM04.ressources[i]);		}	}	// Ajout d'une ressource vide	else {		STIM04_Ressource_Append();	}	// Simulation des événements au rechargement	STIM04_PartnerSociete_Populate();		STIM04_ModeAcces_OnChange();});	// Soumissionfunction STIM04_Submit() {	// Anti double clic	if(fmr.document.hasBeenSent) return false;	// Backup != demandeur	if($("#Forms_RequesterBackup").val() != "") {		if($("#Forms_RequesterBackup").val().toUpperCase().indexOf(Form.Requester.AbbreviatedName.toUpperCase()) != -1) { DisplayErrMsgOnField("Forms_RequesterBackup", l_Forms_Err_RequesterCantBeOwnBackup); return false; }	}	// Bénéficiaire MOA	if($("#STIM04_BenefMOA").val().trim() == "") { DisplayErrMsgOnField("STIM04_BenefMOA", l_Forms_Err_ChampObligatoire + "\"" + l_STIM04_BenefMOA + "\" !"); return false; }	if($("#STIM04_EntiteMOA").val().trim() == "") { DisplayErrMsgOnField("STIM04_EntiteMOA", l_Forms_Err_ChampObligatoire + "\"" + l_STIM04_EntiteMOA + "\" !"); return false; }	// Bénéficiaire MOE	if($("#STIM04_BenefMOE").val().trim() == "") { DisplayErrMsgOnField("STIM04_BenefMOE", l_Forms_Err_ChampObligatoire + "\"" + l_STIM04_BenefMOE + "\" !"); return false; }	if($("#STIM04_EntiteMOE").val().trim() == "") { DisplayErrMsgOnField("STIM04_EntiteMOE", l_Forms_Err_ChampObligatoire + "\"" + l_STIM04_EntiteMOE + "\" !"); return false; }	// Date d'ouverture obligatoire et au bon format	var strTmp = $("#STIM04_DateDebut").val().trim();	if(strTmp == "") { DisplayErrMsgOnField("STIM04_DateDebut", l_Forms_Err_ChampObligatoire + "\"" + l_STIM04_DateDebut + "\" !"); return false; }	var DateFormat = /^(([3][0-1])|([0-2][0-9]))\/(([1][0-2])|([0][0-9]))\/((19)|(20))[0-9][0-9]$/;	if(!DateFormat.test(strTmp)) { DisplayErrMsgOnField("STIM04_DateDebut", l_Forms_Err_DateFormat); return false; }	var dateStart = new Date(strTmp.substr(6, 4), Number(strTmp.substr(3, 2)) - 1, strTmp.substr(0, 2), 0, 0, 0);	var dateLimit = new Date();	dateLimit.setTime(dateLimit.getTime() + 8*24*60*60*1000);		dateLimit.setHours(0); dateLimit.setMinutes(0); dateLimit.setSeconds(0, 0);	if(dateStart.getTime() < dateLimit.getTime()) { DisplayErrMsgOnField("STIM04_DateDebut", l_STIM04_DateDebut_ErrWrongDate); return false; }	// Description du projet	if($("#STIM04_DescProjet").val().trim() == "") { DisplayErrMsgOnField("STIM04_DescProjet", l_Forms_Err_ChampObligatoire + "\"" + l_STIM04_DescProjet + "\" !"); return false; }	// Partenaire pressenti	if($("#STIM04_PartnerSociete").val().trim() == "") { DisplayErrMsgOnField("STIM04_PartnerSociete", l_Forms_Err_ChampObligatoire + "\"" + l_STIM04_PartnerSociete + "\" !"); return false; }	// Mode d'accès	var strModeAcces = $("#STIM04_ModeAcces").val().trim(); 	if(strModeAcces == "") { DisplayErrMsgOnField("STIM04_ModeAcces", l_Forms_Err_ChampObligatoire + "\"" + l_STIM04_ModeAcces + "\" !"); return false; }	// Entreprise étendue, Profil	if(strModeAcces == "ENTETENDUE") {		if($("#STIM04_ProfilEE").val().trim() == "") { DisplayErrMsgOnField("STIM04_ProfilEE", l_Forms_Err_ChampObligatoire + "\"" + l_STIM04_ProfilEE + "\""); return false; }	}	// Autre mode d'accès	else {			// Boucle sur les ressources		var boolRessourceOK = false; 		$(".STIM04_Ressource").each(function() {			boolRessourceOK = false;			var strUID = this.id.strRightBack("_").toLowerCase().trim();			var strStatus = $("#STIM04_Ressource_Status_" + strUID).val().trim();			// Type			var strType = $("#STIM04_Ressource_Type_" + strUID).val().trim();			if(strType == "") { DisplayErrMsgOnField("STIM04_Ressource_Type_" + strUID, l_Forms_Err_ChampObligatoire + "\"" + l_STIM04_Ressource_Type + "\" !"); return false; }			// Type 'Autre"			if((strType == "OTHER") && ($("#STIM04_Ressource_SubType_" + strUID).val().trim() == "")) { DisplayErrMsgOnField("STIM04_Ressource_SubType_" + strUID, l_Forms_Err_ChampObligatoire + "\"" + l_STIM04_Ressource_SubType + "\" !"); return false; }			// Si URL/VIP			if(strType == "URL" || strType == "VIP") {										// URL				if($("#STIM04_Ressource_URL_" + strUID).val().trim() == "") { DisplayErrMsgOnField("STIM04_Ressource_URL_" + strUID, l_Forms_Err_ChampObligatoire + "\"" + l_STIM04_Ressource_URL + "\" !"); return false; }				// Application saisie				if($("#STIM04_Ressource_App_" + strUID).val().trim() == "") { DisplayErrMsgOnField("STIM04_Ressource_App_" + strUID, l_Forms_Err_ChampObligatoire + "\"" + l_STIM04_Ressource_App + "\" !"); return false; }								// Application vérifiée si nouvelle ressource				if((strStatus != "OK" && strStatus != "KO") && $("#STIM04_Ressource_App_" + strUID).is(":visible")) { DisplayErrMsgOnField("STIM04_Ressource_App_" + strUID, l_STIM04_Ressource_App_ErrNotVerified); return false; }			}			// Pas URL ni VIP			else {				// Serveur saisie				if($("#STIM04_Ressource_Server_" + strUID).val().trim() == "") { DisplayErrMsgOnField("STIM04_Ressource_Server_" + strUID, l_Forms_Err_ChampObligatoire + "\"" + l_STIM04_Ressource_Server + "\" !"); return false; }				// Serveur vérifié si nouvelle ressource				if((strStatus != "OK") && (strStatus != "KO") && $("#STIM04_Ressource_Server_" + strUID).is(":visible")) { DisplayErrMsgOnField("STIM04_Ressource_Server_" + strUID, l_STIM04_Ressource_Server_ErrNotVerified); return false; }			}			// Protocole			if($("#STIM04_Ressource_Protocol_" + strUID).val().trim() == "") { DisplayErrMsgOnField("STIM04_Ressource_Protocol_" + strUID, l_Forms_Err_ChampObligatoire + "\"" + l_STIM04_Ressource_Protocol + "\" !"); return false; }			boolRessourceOK = true;		});		if(!boolRessourceOK) return false;		// Risques		if($("#STIM04_Risques").val().trim() == "") { DisplayErrMsgOnField("STIM04_Risques", l_Forms_Err_ChampObligatoire + "\"" + l_STIM04_Risques + "\" !"); return false; }	}	// Confirmation de la soumission	if(confirm(l_Conf_Submit)) {		STIM04_Ressources_Serialize();		fmr.document.hasBeenSent = true;		$("#f_ActionAFaire").val("soumettre");		document.forms[0].submit();	}}// Calendrier "Date"function STIM04_DateDebut_DatePicker(caller) {	// Nom du champ	if(caller.tagName.toUpperCase() == "IMG")		var strFieldName = $(caller).parents("td").find("input").attr("id");	else		var strFieldName = caller.id;		// Minimum: date du jour + 8	var dateMin = new Date();	dateMin.setTime(dateMin.getTime() + 7*24*60*60*1000);	// Calendrier	calendrier_heure.hidePopup();	calendrier_datejou.hidePopup();	calendrier_datejou.disabledDatesExpression = "";	calendrier_datejou.setReturnFunction("STIM04_DateDebut_CallBack");	calendrier_datejou.addDisabledDates(null, (dateMin.getMonth() + 1).toString().padLeft("0", 2) + "/" + dateMin.getDate().toString().padLeft("0", 2) + "/" + dateMin.getFullYear());	calendrier_datejou.select(document.getElementById(strFieldName), strFieldName, "dd/MM/yyyy");}// Mise à jour de la date d'ouverture, reconstruction de la liste des partenairesfunction STIM04_DateDebut_CallBack(year, month, day) {	$("#STIM04_DateDebut").val(day.toString().padLeft("0", 2) + "/" + month.toString().padLeft("0", 2) + "/" + year);	STIM04_PartnerSociete_Populate();}// Construction de la liste de partenairesfunction STIM04_PartnerSociete_Populate() {	jqoTmp = $("#STIM04_PartnerSociete").empty();		var strTmp = $("#STIM04_DateDebut").val().trim();	var DateFormat = /^(([3][0-1])|([0-2][0-9]))\/(([1][0-2])|([0][0-9]))\/((19)|(20))[0-9][0-9]$/;		if((strTmp == "") || !DateFormat.test(strTmp)) return;	var dateStart = new Date(strTmp.substr(6, 4), Number(strTmp.substr(3, 2)) - 1, strTmp.substr(0, 2), 0, 0, 0);		// Boucle sur les partenaires	strHTML = "<option></option>";	for(var i = 0, j = STIM04.partners.length; i < j; i++) {		// Si le partenaire est toujours valide à la date d'ouverture		var dateValid = new Date(STIM04.partners[i].dateValid.substr(6, 4), Number(STIM04.partners[i].dateValid.substr(3, 2)) - 1, STIM04.partners[i].dateValid.substr(0, 2), 0, 0, 0);		if(dateValid.getTime() > dateStart.getTime()) {			strHTML += "<option value=\"" + STIM04.partners[i].name + "§" + STIM04.partners[i].confidenceLevel + "§" + STIM04.partners[i].dateValid + "\"" + (STIM04.partners[i].name == STIM04.partner.strLeft("§") ? " selected" : "") + ">" + STIM04.partners[i].name + "</option>";		}	}	jqoTmp.append(strHTML).change();}// Choix d'un partenairefunction STIM04_PartnerSociete_OnChange() {	var strTmp = $("#STIM04_PartnerSociete").val().trim();	if(strTmp != "") {		arrTmp = strTmp.split("§");		switch(arrTmp[1]) {			case "0": $("#STIM04_Partner_ConfidenceLevel_Cell").html(l_STIM04_ConfianceFaible); break;			case "1": $("#STIM04_Partner_ConfidenceLevel_Cell").html(l_STIM04_ConfianceMoyen); break;			case "2": $("#STIM04_Partner_ConfidenceLevel_Cell").html(l_STIM04_ConfianceEleve);		}		$("#STIM04_DateFin_Cell").html(arrTmp[2]);		$("#STIM04_Partner_DateValid_Cell").html(arrTmp[2]);	}	else {		$("#STIM04_DateFin_Cell").html("");		$("#STIM04_Partner_ConfidenceLevel_Cell").html("");		$("#STIM04_Partner_DateValid_Cell").html("");	}}// Choix d'un mode d'accèsfunction STIM04_ModeAcces_OnChange() {		// URL de la base	var strDBPath = window.location.href.strLeft(".nsf") + ".nsf";	var strModeAcces = $("#STIM04_ModeAcces").val().toUpperCase();	// Changement de l'image "Mode d'acccès"	$("#STIM04_ModeAccesImg").attr("src", (strModeAcces == "PLATEAUPSA" || strModeAcces == "VPNTIERS" || strModeAcces == "ENTETENDUE") ? strDBPath + "/STIM04_" + strModeAcces + ".png" : "/icons/ecblank.gif");	// Entreprise étendue	if(strModeAcces == "ENTETENDUE") {		// Affichage du champs "Profil"		var jqoTmp = $("#STIM04_ProfilEE").parents("tr").eq(0);		jqoTmp.prev().show();		jqoTmp.show();		jqoTmp.next().show();		// Masquage des champs DICT, affichage du <span> pour le contenu dynamique		$("#STIM04_DICT_D").hide();		$("#STIM04_DICT_I").hide();		$("#STIM04_DICT_C").hide();		$("#STIM04_DICT_T").hide();		$("#MandatoryImg_STIM04_DICT").hide();		$("#STIM04_DICT_EE").html("").show();					// Masquage du bloc "Ressources"		$("#STIM04_Ressources").hide();		$("td.STIM04-Ressources").each(function() { $(this).parents("tr").eq(0).hide(); });				// Masquage des champs "Description" des risques techniques et organisationnels, affichage des <span> pour le contenu dynamique		$("#STIM04_Risques").parent("div").hide();		$("#MandatoryImg_STIM04_Risques").hide();		$("#STIM04_Risques_EE").html("").show();	}	else {		var jqoTmp = $("#STIM04_ProfilEE").parents("tr").eq(0);		jqoTmp.next().hide();		jqoTmp.hide();		jqoTmp.prev().hide();		$("#STIM04_ProfilEE").val("");		$("#STIM04_DICT_EE").hide();		$("#MandatoryImg_STIM04_DICT").show();		$("#STIM04_DICT_D").show();		$("#STIM04_DICT_I").show();		$("#STIM04_DICT_C").show();		$("#STIM04_DICT_T").show();		$("#STIM04_Ressources").show();		$("td.STIM04-Ressources").each(function() { $(this).parents("tr").eq(0).show(); });		$("#STIM04_Risques_EE").hide();		$("#MandatoryImg_STIM04_Risques").show();		$("#STIM04_Risques").parent("div").show();	}}// Bloc ressourcefunction STIM04_Ressource_GetForm(ressource) {		// Nettoyage des paramètres	if((ressource === undefined) || (ressource.uid === undefined) || (typeof ressource.uid != "string")) return "";	if((ressource.type === undefined) || (typeof ressource.type != "string")) ressource.type = "";	ressource.type = ressource.type.trim().toUpperCase();	if((ressource.subtype === undefined) || (typeof ressource.subtype != "string") || (ressource.subtype == "-")) ressource.subtype = "";	if((ressource.server === undefined) || (typeof ressource.server != "string") || (ressource.server == "-")) ressource.server = "";	if((ressource.url === undefined) || (typeof ressource.url != "string") || (ressource.url == "-")) ressource.url = "";	if((ressource.app === undefined) || (typeof ressource.app != "string") || (ressource.app == "-")) ressource.app = "";	if((ressource.dicts === undefined) || (typeof ressource.dicts != "string")) ressource.dicts = "";	if((ressource.protocol === undefined) || (typeof ressource.protocol != "string")) ressource.protocol = "";	ressource.protocol = ressource.protocol.trim().toUpperCase();	if((ressource.status === undefined) || (typeof ressource.status != "string") || (ressource.status.trim() == "")) ressource.status = "-";	ressource.status = ressource.status.trim().toUpperCase();	if((ressource.checked === undefined) || (typeof ressource.checked != "boolean")) ressource.checked = false;	if((ressource.idx === undefined) || (typeof ressource.idx != "number")) ressource.idx = "?";	// URL de la base	var strDBPath = window.location.href.strLeft(".nsf") + ".nsf";	// Libellé d'un champ	var getFieldLabel = function(strLabel) {		return "<td><img src=\"" + strDBPath + "/mandatoryfield_cacheable.gif?OpenImageResource\" border=\"0\" width=\"16\" height=\"16\" align=\"top\"></td><td class=\"FieldLegend\">" + strLabel + "&nbsp;:</td>";	};	// Affichage d'un champ	var getFieldHTML = function(strLabel, strValue, strInputId, strInputVal) {		return "<td></td><td class=\"FieldLegend\">" + strLabel + "&nbsp;:</td><td>" + strValue + "<input type=\"hidden\" id=\"" + strInputId + "\" value=\""+ strInputVal + "\"></td>";	};	// Tableau et colonne	var strHTML = "<table cellspacing=\"2\" cellpadding=\"0\" class=\"STIM04_Ressource\" id=\"STIM04_Ressource_" + ressource.uid + "\">";	strHTML += "<colgroup><col width=\"16\"><col width=\"173\"><col width=\"378\"><col width=\"189\"></colgroup>";	// Ligne d'entête	strHTML += "<tr valign=\"middle\">";	strHTML += "<th colspan=\"4\" valign=\"middle\"" + ((ressource.status == "OK" || ressource.status == "KO") ? " class=\"" + ressource.status + "\"" : "") + ">";		strHTML += "<table border=\"0\" cellpadding=\"0\" cellspacing=\"2\" width=\"100%\">";		strHTML += "<tr>";			strHTML += "<td style=\"vertical-align: middle;\"><span style=\"font-weight: bold;\" class=\"STIM04_Ressource_Title\">" + l_STIM04_Ressource_Title + ressource.idx + "</span></td>";			strHTML += "<td style=\"text-align: right; vertical-align: middle;\"><img src=\"" + strDBPath + "/close.gif?OpenImageResource\" onclick=\"STIM04_Ressource_Remove(this);\" style=\"cursor: pointer;\" border=\"0\" width=\"14\" height=\"14\" class=\"delete\"></td>";		strHTML += "</tr>";		strHTML += "</table>";		strHTML += "<input type=\"hidden\" id=\"STIM04_Ressource_DICTs_" + ressource.uid + "\" value=\"" + ressource.dicts + "\">";		strHTML += "<input type=\"hidden\" id=\"STIM04_Ressource_Status_" + ressource.uid + "\" value=\"" + ressource.status + "\">";	strHTML += "</th>";	strHTML += "</tr>";	// Nouvelle ressource	if(ressource.status != "OK" && ressource.status != "KO") {			// Type de ressource		strHTML += "<tr>";		strHTML += getFieldLabel(l_STIM04_Ressource_Type);		strHTML += "<td>";		strHTML += "<select id=\"STIM04_Ressource_Type_" + ressource.uid + "\" onChange=\"STIM04_Ressource_Type_OnChange('" + ressource.uid + "', this);\">";		strHTML += "<option value=\"\"></option>";		strHTML += "<option value=\"Server\"" + (ressource.type == "SERVER" ? " selected" : "") + ">" + l_STIM04_Ressource_Type_Server + "</option>";		strHTML += "<option value=\"VIP\"" + (ressource.type == "VIP" ? " selected" : "") + ">" + l_STIM04_Ressource_Type_VIP + "</option>";		strHTML += "<option value=\"URL\"" + (ressource.type == "URL" ? " selected" : "") + ">" + l_STIM04_Ressource_Type_URL + "</option>";		strHTML += "<option value=\"OTHER\"" + (ressource.type == "OTHER" ? " selected" : "") + ">" + l_STIM04_Ressource_Type_Other + "</option>";		strHTML += "</select>";		strHTML += "</td>";		strHTML += "<td></td>";		strHTML += "</tr>";		// Type de ressource ("Autre")		strHTML += "<tr" + (ressource.type != "OTHER" ? " style=\"display: none;\"" : "") + ">";		strHTML += getFieldLabel(l_STIM04_Ressource_SubType);		strHTML += "<td>"		strHTML += "<input type=\"text\" id=\"STIM04_Ressource_SubType_" + ressource.uid + "\" style=\"width: 100%\" value=\"" + ressource.subtype + "\">";		strHTML += "</td>";		strHTML += "<td></td>";		strHTML += "</tr>";		// Serveur		strHTML += "<tr" + (ressource.type != "SERVER" && ressource.type != "OTHER" ? " style=\"display: none;\"" : "") + ">";		strHTML += getFieldLabel(l_STIM04_Ressource_Server);		strHTML += "<td>"		// Mode édition	(masqué si serveur validé)		strHTML += "<div id=\"STIM04_Ressource_Server_" + ressource.uid + "_Edit\"" + ((ressource.type == "SERVER" || ressource.type == "OTHER") && ressource.checked ? " style=\"display: none;\"" : "") + ">";		strHTML += "<input type=\"text\" id=\"STIM04_Ressource_Server_" + ressource.uid + "\" value=\"" + ressource.server + "\" onChange=\"this.value=this.value.trim().toUpperCase();\">";		strHTML += "<button class=\"ui-state-default\" style=\"vertical-align: middle; margin-left: 0.5em;\" onMouseOver=\"$(this).addClass('ui-state-hover').removeClass('ui-state-default');\" onMouseOut=\"$(this).removeClass('ui-state-hover').addClass('ui-state-default');\" onClick=\"STIM04_Ressource_Server_Check('" + ressource.uid + "'); return false;\">" + l_STIM04_Ressource_BtnCheck + "</button>"		strHTML += "<img src=\"" + strDBPath + "/ajax-loader_cacheable.gif?OpenImageResource\" height=\"16\" width=\"16\" style=\"margin-left: 0.5em; display: none;\" id=\"STIM04_Ressource_Server_AJAXLoader\">"		strHTML += "</div>";		// Mode lecture (si serveur validé)		if((ressource.type == "SERVER" || ressource.type == "OTHER") && ressource.checked) {			strHTML += "<div id=\"STIM04_Ressource_Server_" + ressource.uid + "_View\">";			strHTML += "<span>" + ressource.server + "</span><img src=\"/icons/vwicn058.gif\" style=\"vertical-align: middle; margin-left: 0.5em; cursor: pointer;\" onclick=\"STIM04_Ressource_Server_Edit('" + ressource.uid + "');\">";			strHTML += "</div>";		}		strHTML += "</td>";		strHTML += "<td></td>";		strHTML += "</tr>";		// Si un DICT >= 3, affichage d'un warning		if((ressource.type == "SERVER" || ressource.type == "OTHER") && ressource.dicts.match(/[^1-2\-]/gi) != null)			strHTML += "<tr id=\"STIM04_Ressource_Server_" + strUID + "_Warning\"><td colspan=\"2\"></td><td><div class=\"small-help\" style=\"color: #CC3535; margin-bottom: 0.5em;\"><img src=\"/icons/vwicn011.gif\">&nbsp;" + l_STIM04_Ressource_Server_WarningDICT + "</div></td></tr>";		// URL		strHTML += "<tr" + (ressource.type != "URL" && ressource.type != "VIP" ? " style=\"display: none;\"" : "") + ">";		strHTML += getFieldLabel(l_STIM04_Ressource_URL);		strHTML += "<td>"		strHTML += "<input type=\"text\" id=\"STIM04_Ressource_URL_" + ressource.uid + "\" style=\"width: 100%\" value=\"" + ressource.url + "\">";		strHTML += "</td>";		strHTML += "<td></td>";		strHTML += "</tr>";		// Application		strHTML += "<tr" + (ressource.type != "URL" && ressource.type != "VIP" ? " style=\"display: none;\"" : "") + ">";		strHTML += getFieldLabel(l_STIM04_Ressource_App);		strHTML += "<td>"		// Mode édition	(masqué si application validée)		strHTML += "<div id=\"STIM04_Ressource_App_" + ressource.uid + "_Edit\"" + ((ressource.type == "URL" || ressource.type == "VIP") && ressource.checked ? " style=\"display: none;\"" : "") + ">";		strHTML += "<input type=\"text\" id=\"STIM04_Ressource_App_" + ressource.uid + "\" value=\"" + ressource.app + "\" onChange=\"this.value=this.value.trim().toUpperCase();\">";		strHTML += "<button class=\"ui-state-default\" style=\"vertical-align: middle; margin-left: 0.5em;\" onMouseOver=\"$(this).addClass('ui-state-hover').removeClass('ui-state-default');\" onMouseOut=\"$(this).removeClass('ui-state-hover').addClass('ui-state-default');\" onClick=\"STIM04_Ressource_App_Check('" + ressource.uid + "'); return false;\">" + l_STIM04_Ressource_BtnCheck + "</button>"		strHTML += "<img src=\"" + strDBPath + "/ajax-loader_cacheable.gif?OpenImageResource\" height=\"16\" width=\"16\" style=\"margin-left: 0.5em; display: none;\" id=\"STIM04_Ressource_App_AJAXLoader\">"		strHTML += "</div>";		// Mode lecture (si application validée)		if((ressource.type == "URL" || ressource.type == "VIP") && ressource.checked) {			strHTML += "<div id=\"STIM04_Ressource_App_" + ressource.uid + "_View\">";			strHTML += "<span>" + ressource.app + "</span><img src=\"/icons/vwicn058.gif\" style=\"vertical-align: middle; margin-left: 0.5em; cursor: pointer;\" onclick=\"STIM04_Ressource_App_Edit('" + ressource.uid + "');\">";			strHTML += "</div>";		}		strHTML += "</td>";		strHTML += "<td></td>";		strHTML += "</tr>";		// Si un DICT >= 3, affichage d'un warning		if((ressource.type == "URL" || ressource.type == "VIP") && ressource.dicts.match(/[^1-2\-]/gi) != null)			strHTML += "<tr id=\"STIM04_Ressource_App_" + strUID + "_Warning\"><td colspan=\"2\"></td><td><div class=\"small-help\" style=\"color: #CC3535; margin-bottom: 0.5em;\"><img src=\"/icons/vwicn011.gif\">&nbsp;" + l_STIM04_Ressource_App_WarningDICT + "</div></td></tr>";		// Protocole		strHTML += "<tr" + (ressource.type != "SERVER" && ressource.type != "URL" && ressource.type != "VIP" && ressource.type != "OTHER" ? " style=\"display: none;\"" : "") + ">";		strHTML += getFieldLabel(l_STIM04_Ressource_Protocol);		strHTML += "<td>"		strHTML += "<select id=\"STIM04_Ressource_Protocol_" + ressource.uid + "\">";		strHTML += "<option></option>";		for(var i = 0, j = STIM04.protocols.length; i < j; i++) {			strHTML += "<option value=\"" + STIM04.protocols[i].trim().toUpperCase() + "\"" + (ressource.protocol.trim().toUpperCase() == STIM04.protocols[i].trim().toUpperCase() ? " selected" : "") + ">" + STIM04.protocols[i] + "</option>";		}		strHTML += "</select>";		strHTML += "</td>";		strHTML += "<td></td>";		strHTML += "</tr>";	}	// Ressource validée	else {		// Type de ressource		strTmp = "?";		switch(ressource.type) {			case "SERVER": strTmp = l_STIM04_Ressource_Type_Server; break;			case "VIP": strTmp = l_STIM04_Ressource_Type_VIP; break;			case "URL": strTmp = l_STIM04_Ressource_Type_URL; break;			case "OTHER": strTmp = l_STIM04_Ressource_Type_Other;		}		strHTML += "<tr>" + getFieldHTML(l_STIM04_Ressource_Type, strTmp, "STIM04_Ressource_Type_" + ressource.uid, ressource.type) + "</tr>";		// Type de ressource ("Autre")		if(ressource.type == "OTHER")			strHTML += "<tr>" + getFieldHTML(l_STIM04_Ressource_SubType, ressource.subtype, "STIM04_Ressource_SubType_" + ressource.uid, ressource.subtype) + "</tr>";		// Serveur		if(ressource.type == "SERVER" || ressource.type == "OTHER")			strHTML += "<tr>" + getFieldHTML(l_STIM04_Ressource_Server, ressource.server, "STIM04_Ressource_Server_" + ressource.uid, ressource.server) + "</tr>";		// URL		if(ressource.type == "URL" || ressource.type == "VIP")			strHTML += "<tr>" + getFieldHTML(l_STIM04_Ressource_URL, ressource.url, "STIM04_Ressource_URL_" + ressource.uid, ressource.url) + "</tr>";		// Application		if(ressource.type == "URL" || ressource.type == "VIP")			strHTML += "<tr>" + getFieldHTML(l_STIM04_Ressource_App, ressource.app, "STIM04_Ressource_App_" + ressource.uid, ressource.app) + "</tr>";		// Protocole		strHTML += "<tr>" + getFieldHTML(l_STIM04_Ressource_Protocol, ressource.protocol, "STIM04_Ressource_Protocol_" + ressource.uid, ressource.protocol) + "<td>"	}	// Fermeture	strHTML += "</table>";	return strHTML;}// Ajout d'une ressourcefunction STIM04_Ressource_Append(ressource) {	var jqoRessources = $(".STIM04_Ressource");	// Pas de ressource en paramètre	if(ressource === undefined) {		ressource = {uid: fmr.utils.randomString(10)};	}	// Ressource en paramètre	else {		// On boucle tant que l'on n'a pas réussit à générer un identifiant unique		var isUnique = true;		do {			strUID = fmr.utils.randomString(10);					// Vérification de l'unicité			jqoRessources.each(function() {				if(this.id.strRightBack("_").toLowerCase().trim() == strUID) {					isUnique = false;					return false;				}			});		} while(!isUnique);		ressource.uid = strUID	}		ressource.idx = jqoRessources.length + 1;		$("#STIM04_Ressources").append(STIM04_Ressource_GetForm(ressource));}// Retrait d'une ressourcefunction STIM04_Ressource_Remove(caller) {		var jqoTable = $(caller).parents(".STIM04_Ressource").eq(0);	var strUID = jqoTable[0].id.strRightBack("_").toLowerCase().trim();	var jqoStatus = $("#STIM04_Ressource_Status_" + strUID);	var strStatus = jqoStatus.val().trim();	var jqoToggleBtn = jqoTable.find("img.delete");		// Nouvelle ressource, retrait	if(strStatus != "OK" && strStatus != "KO") {				// Retrait de la ressource		jqoTable.remove();		// Si il ne reste aucune ressource, on en ajoute une		if($(".STIM04_Ressource").length == 0) {			STIM04_Ressource_Append();		}		// Sinon, mise à jour des indices dans les titres des ressources		else {			$(".STIM04_Ressource_Title").each(function(i) {				$(this).html(l_STIM04_Ressource_Title + (i+1));			});		}	}	// Ressource validée, préparation du retrait	else if(strStatus == "OK") {		jqoTable.find("th").removeClass("OK").addClass("KO");		jqoStatus.val("KO");		jqoToggleBtn.attr("src", "/icons/vwicn198.gif");	}	// Ressource prête pour retrait, validation	else {		jqoTable.find("th").removeClass("KO").addClass("OK");		jqoStatus.val("OK");		jqoToggleBtn.attr("src", window.location.href.strLeft(".nsf") + ".nsf/close.gif");	}}// Choix du type de ressourcefunction STIM04_Ressource_Type_OnChange(i, caller) {	var strUID = caller.id.strRightBack("_").toLowerCase().trim();	// undefined en paramètre = pas de valeur sélectionnée, masquage des champs liés au choix	if(caller === undefined) {		$("#STIM04_Ressource_SubType_" + strUID).parents("tr").eq(0).hide();	}	else {		switch($(caller).val().toUpperCase()) {			case "SERVER":				$("#STIM04_Ressource_SubType_" + strUID).parents("tr").eq(0).hide();				$("#STIM04_Ressource_Server_" + strUID).parents("tr").eq(0).show();				$("#STIM04_Ressource_URL_" + strUID).parents("tr").eq(0).hide();				$("#STIM04_Ressource_App_" + strUID).parents("tr").eq(0).hide();				$("#STIM04_Ressource_App_" + strUID + "_Warning").parents("tr").eq(0).hide();				$("#STIM04_Ressource_Protocol_" + strUID).parents("tr").eq(0).show();				break;			case "OTHER":				$("#STIM04_Ressource_SubType_" + strUID).parents("tr").eq(0).show();				$("#STIM04_Ressource_Server_" + strUID).parents("tr").eq(0).show();				$("#STIM04_Ressource_URL_" + strUID).parents("tr").eq(0).hide();				$("#STIM04_Ressource_App_" + strUID).parents("tr").eq(0).hide();				$("#STIM04_Ressource_App_" + strUID + "_Warning").parents("tr").eq(0).hide();				$("#STIM04_Ressource_Protocol_" + strUID).parents("tr").eq(0).show();				break;			case "URL":			case "VIP":				$("#STIM04_Ressource_SubType_" + strUID).parents("tr").eq(0).hide();				$("#STIM04_Ressource_Server_" + strUID).parents("tr").eq(0).hide();				$("#STIM04_Ressource_Server_" + strUID + "_Warning").hide();				$("#STIM04_Ressource_URL_" + strUID).parents("tr").eq(0).show();				$("#STIM04_Ressource_App_" + strUID).parents("tr").eq(0).show();				$("#STIM04_Ressource_Protocol_" + strUID).parents("tr").eq(0).show();				break;			default:				$("#STIM04_Ressource_SubType_" + strUID).parents("tr").eq(0).hide();				$("#STIM04_Ressource_Server_" + strUID).parents("tr").eq(0).hide();				$("#STIM04_Ressource_Server_" + strUID + "_Warning").hide();				$("#STIM04_Ressource_URL_" + strUID).parents("tr").eq(0).hide();				$("#STIM04_Ressource_App_" + strUID).parents("tr").eq(0).hide();				$("#STIM04_Ressource_App_" + strUID + "_Warning").hide();				$("#STIM04_Ressource_Protocol_" + strUID).parents("tr").eq(0).hide();				break;		}		}	}// Modification d'une applicationfunction STIM04_Ressource_App_Edit(strUID) {	$("#STIM04_Ressource_App_" + strUID + "_Edit").show();	$("#STIM04_Ressource_App_" + strUID + "_View").hide().html("");	$("#STIM04_Ressource_App_" + strUID + "_Warning").hide();}// Vérification d'une applicationfunction STIM04_Ressource_App_Check(strUID) {	var jqoTmp = $("#STIM04_Ressource_App_" + strUID);	if(jqoTmp.length == 0) return;		// Application	var strAppName = $("#STIM04_Ressource_App_" + strUID).val().toUpperCase().trim();	if(strAppName == "") return;		// Vérification de l'existance de l'application dans REFLEX	$("#STIM04_Ressource_App_AJAXLoader").show();	$.ajax({		url: window.location.href.strLeft(".nsf") + ".nsf/STIM04_WSR_App?OpenAgent&App=" + strAppName,		type: 'GET', dataType: 'xml', cache: false, timeout: 30000,		// Echec de la requête		error: function() {			$("#STIM04_Ressource_App_AJAXLoader").hide();			alert(l_Forms_Err_AJAX);		},		// Réussite de la requête		success: function(xml) {			$("#STIM04_Ressource_App_AJAXLoader").hide();						// On doit recevoir une application			if(xml.getElementsByTagName("ns1:ApplicationInfo").length == 0) {				DisplayErrMsgOnField("STIM04_Ressource_App_" + strUID, l_STIM04_Ressource_App_ErrNotFound + "\"" + strAppName + "\" !");			}			else {							// Masquage du champ de saisie				var jqoEdit = $("#STIM04_Ressource_App_" + strUID + "_Edit").hide();				// Affichage du bloc en lecture seule				var strHTML = "<span>" + strAppName + "</span><img src=\"/icons/vwicn058.gif\" style=\"vertical-align: middle; margin-left: 0.5em; cursor: pointer;\" onclick=\"STIM04_Ressource_App_Edit('" + strUID + "');\">";				var jqoView = $("#STIM04_Ressource_App_" + strUID + "_View");				if(jqoView.length == 0)					jqoEdit.after("<div id=\"STIM04_Ressource_App_" + strUID + "_View\">" + strHTML + "</div>");				else					jqoView.html(strHTML).show(); 				// Pas de DICT, affichage d'un warning				var jqoWarning = $("#STIM04_Ressource_App_" + strUID + "_Warning");				var htmlcolDICT = xml.getElementsByTagName("ns1:Dic");				if(htmlcolDICT.length == 0) {					// Mémorisation dans le document					$("#STIM04_Ressource_DICTs_" + strUID).val("-");					// Création de la ligne du warning si besoin					if(jqoWarning.length == 0)						jqoEdit.parents("tr").after("<tr id=\"STIM04_Ressource_App_" + strUID + "_Warning\"><td colspan=\"2\"></td><td><div class=\"small-help\" style=\"color: #CC3535; margin-bottom: 0.5em;\"><img src=\"/icons/vwicn011.gif\" style=\"cursor: pointer;\">&nbsp;" + l_STIM04_Ressource_App_WarningNoDICT + "</div></td></tr>");					else						jqoWarning.show();										}				else {									// Boucle sur les DICT, pour mémorisation dans le document					var arrDICTs = [];					for(var i = 0, j = htmlcolDICT.length; i < j; i++) {						arrDICTs.push(htmlcolDICT[i].childNodes[0].nodeValue.trim());					}					var strDICTs = arrDICTs.join("-");					$("#STIM04_Ressource_DICTs_" + strUID).val(strDICTs);					// Si un DICT >= 3, affichage d'un warning					if(strDICTs.match(/[3-4]/gi) != null) {												// Création de la ligne du warning si besoin						if(jqoWarning.length == 0)							jqoEdit.parents("tr").after("<tr id=\"STIM04_Ressource_App_" + strUID + "_Warning\"><td colspan=\"2\"></td><td><div class=\"small-help\" style=\"color: #CC3535; margin-bottom: 0.5em;\"><img src=\"/icons/vwicn011.gif\" onClick=\"fmr.utils.helpPopup(l_STIM04_Ressource_App_WarningDICT_HelpTitle, l_STIM04_Ressource_App_WarningDICT_HelpMsg);\" style=\"cursor: pointer;\">&nbsp;" + l_STIM04_Ressource_App_WarningDICT + "</div></td></tr>");						else							jqoWarning.show();											}					// Sinon, masquage du warning					else						jqoWarning.hide();				}			}		}	});}// Modification d'un serveurfunction STIM04_Ressource_Server_Edit(strUID) {	$("#STIM04_Ressource_Server_" + strUID + "_Edit").show();	$("#STIM04_Ressource_Server_" + strUID + "_View").hide().html("");	$("#STIM04_Ressource_Server_" + strUID + "_Warning").hide();}// Vérification d'un serveurfunction STIM04_Ressource_Server_Check(strUID) {	var jqoTmp = $("#STIM04_Ressource_Server_" + strUID);	if(jqoTmp.length == 0) return;		// Serveur	var strServer = $("#STIM04_Ressource_Server_" + strUID).val().toUpperCase().trim();	if(strServer == "") return;		// Si le serveur est un FAN poste fixe/portable	var fanFormat = /^B[0-9]{6}$/;	if(fanFormat.test(strServer)) {		// Masquage du champ de saisie		var jqoEdit = $("#STIM04_Ressource_Server_" + strUID + "_Edit").hide();		// Affichage du bloc en lecture seule		var strHTML = "<span>" + strServer + "</span><img src=\"/icons/vwicn058.gif\" style=\"vertical-align: middle; margin-left: 0.5em; cursor: pointer;\" onclick=\"STIM04_Ressource_Server_Edit('" + strUID + "');\">";		var jqoView = $("#STIM04_Ressource_Server_" + strUID + "_View");		if(jqoView.length == 0)			jqoEdit.after("<div id=\"STIM04_Ressource_Server_" + strUID + "_View\">" + strHTML + "</div>");		else			jqoView.html(strHTML).show(); 		// Mémorisation dans le document		$("#STIM04_Ressource_DICTs_" + strUID).val("-");		// Création de la ligne du warning si besoin		var jqoWarning = $("#STIM04_Ressource_Server_" + strUID + "_Warning");		if(jqoWarning.length == 0)			jqoEdit.parents("tr").after("<tr id=\"STIM04_Ressource_Server_" + strUID + "_Warning\"><td colspan=\"2\"></td><td><div class=\"small-help\" style=\"color: #CC3535; margin-bottom: 0.5em;\"><img src=\"/icons/vwicn011.gif\" style=\"cursor: pointer;\">&nbsp;" + l_STIM04_Ressource_Server_WarningNoDICT + "</div></td></tr>");		else			jqoWarning.show();							}	// Véritable serveur	else {			// Vérification de l'existance du serveur dans REFLEX		$("#STIM04_Ressource_Server_AJAXLoader").show();		$.ajax({			url: window.location.href.strLeft(".nsf") + ".nsf/STIM04_WSR_Server?OpenAgent&Server=" + strServer,			type: 'GET', dataType: 'xml', cache: false, timeout: 30000,			// Echec de la requête			error: function() {				$("#STIM04_Ressource_Server_AJAXLoader").hide();				alert(l_Forms_Err_AJAX);			},			// Réussite de la reque			success: function(xml) {				$("#STIM04_Ressource_Server_AJAXLoader").hide();				// On doit recevoir des machines				if(xml.getElementsByTagName("ns1:ApplicationMachine").length == 0) {					DisplayErrMsgOnField("STIM04_Ressource_Server_" + strUID, l_STIM04_Ressource_Server_ErrNotFound + "\"" + strServer + "\" !");				}				else {								// Masquage du champ de saisie					var jqoEdit = $("#STIM04_Ressource_Server_" + strUID + "_Edit").hide();					// Affichage du bloc en lecture seule					var strHTML = "<span>" + strServer + "</span><img src=\"/icons/vwicn058.gif\" style=\"vertical-align: middle; margin-left: 0.5em; cursor: pointer;\" onclick=\"STIM04_Ressource_Server_Edit('" + strUID + "');\">";					var jqoView = $("#STIM04_Ressource_Server_" + strUID + "_View");					if(jqoView.length == 0)						jqoEdit.after("<div id=\"STIM04_Ressource_Server_" + strUID + "_View\">" + strHTML + "</div>");					else						jqoView.html(strHTML).show(); 					// Pas de DICT, affichage d'un warning					var jqoWarning = $("#STIM04_Ressource_Server_" + strUID + "_Warning");					var htmlcolDICT = xml.getElementsByTagName("ns1:DicMachine");					if(htmlcolDICT.length == 0) {											// Mémorisation dans le document						$("#STIM04_Ressource_DICTs_" + strUID).val("-");						// Création de la ligne du warning si besoin						if(jqoWarning.length == 0)							jqoEdit.parents("tr").after("<tr id=\"STIM04_Ressource_Server_" + strUID + "_Warning\"><td colspan=\"2\"></td><td><div class=\"small-help\" style=\"color: #CC3535; margin-bottom: 0.5em;\"><img src=\"/icons/vwicn011.gif\" style=\"cursor: pointer;\">&nbsp;" + l_STIM04_Ressource_Server_WarningNoDICT + "</div></td></tr>");						else							jqoWarning.show();											}					// DICT(s) trouvé(s)					else {										// Boucle sur les DICT, pour mémorisation dans le document						var arrDICTs = [];						for(var i = 0, j = htmlcolDICT.length; i < j; i++) {							arrDICTs.push(htmlcolDICT[i].childNodes[0].nodeValue.trim());						}						var strDICTs = arrDICTs.join("-");						$("#STIM04_Ressource_DICTs_" + strUID).val(strDICTs);						// Si un DICT >= 3, affichage d'un warning						if(strDICTs.match(/[3-4]/gi) != null) {													// Création de la ligne du warning si besoin							if(jqoWarning.length == 0)								jqoEdit.parents("tr").after("<tr id=\"STIM04_Ressource_Server_" + strUID + "_Warning\"><td colspan=\"2\"></td><td><div class=\"small-help\" style=\"color: #CC3535; margin-bottom: 0.5em;\"><img src=\"/icons/vwicn011.gif\" onClick=\"fmr.utils.helpPopup(l_STIM04_Ressource_Server_WarningDICT_HelpTitle, l_STIM04_Ressource_Server_WarningDICT_HelpMsg);\" style=\"cursor: pointer;\">&nbsp;" + l_STIM04_Ressource_Server_WarningDICT + "</div></td></tr>");							else								jqoWarning.show();												}						// Sinon, masquage du warning						else							jqoWarning.hide();					}				}			}		});	}}// Sérialisation des ressourcesfunction STIM04_Ressources_Serialize() {	// Boucle sur les ressources	var ressources = {type: [], subtype: [], server: [], url: [], app: [], dicts: [], protocol: [], status: []};	$(".STIM04_Ressource").each(function() {		var strUID = this.id.strRightBack("_").toLowerCase().trim();			var strType = $("#STIM04_Ressource_Type_" + strUID).val();		ressources.type.push(strType);			// DICTs		ressources.dicts.push($("#STIM04_Ressource_DICTs_" + strUID).val());		// Type 'Autre"		if(strType == "OTHER") {			ressources.subtype.push($("#STIM04_Ressource_SubType_" + strUID).val().trim());		}		else			ressources.subtype.push("-");		// Si URL/VIP		if(strType == "URL" || strType == "VIP") {						ressources.url.push($("#STIM04_Ressource_URL_" + strUID).val().trim());			ressources.app.push($("#STIM04_Ressource_App_" + strUID).val().trim());			ressources.server.push("-");		}		// Pas URL ni VIP		else {			ressources.url.push("-");			ressources.app.push("-");			ressources.server.push($("#STIM04_Ressource_Server_" + strUID).val().trim());		}		// Protocole		ressources.protocol.push($("#STIM04_Ressource_Protocol_" + strUID).val().trim());						// Status		ressources.status.push($("#STIM04_Ressource_Status_" + strUID).val().trim());		});	// Sérialisation		var jqoForm = $("form").eq(0);	var jqoTmp = $("#STIM04_Ressources_Type");	var strTmp = ressources.type.join("§");	if(jqoTmp.length == 0)		jqoForm.append("<input type=\"hidden\" id=\"STIM04_Ressources_Type\" name=\"STIM04_Ressources_Type\" value=\"" + strTmp + "\">")	else		jqoTmp.val(strTmp);		var jqoTmp = $("#STIM04_Ressources_DICTs");	var strTmp = ressources.dicts.join("§");	if(jqoTmp.length == 0)		jqoForm.append("<input type=\"hidden\" id=\"STIM04_Ressources_DICTs\" name=\"STIM04_Ressources_DICTs\" value=\"" + strTmp + "\">")	else		jqoTmp.val(strTmp);		var jqoTmp = $("#STIM04_Ressources_SubType");	var strTmp = ressources.subtype.join("§");	if(jqoTmp.length == 0)		jqoForm.append("<input type=\"hidden\" id=\"STIM04_Ressources_SubType\" name=\"STIM04_Ressources_SubType\" value=\"" + strTmp + "\">")	else		jqoTmp.val(strTmp);	var jqoTmp = $("#STIM04_Ressources_Server");	var strTmp = ressources.server.join("§");	if(jqoTmp.length == 0)		jqoForm.append("<input type=\"hidden\" id=\"STIM04_Ressources_Server\" name=\"STIM04_Ressources_Server\" value=\"" + strTmp + "\">")	else		jqoTmp.val(strTmp);	var jqoTmp = $("#STIM04_Ressources_URL");	var strTmp = ressources.url.join("§");	if(jqoTmp.length == 0)		jqoForm.append("<input type=\"hidden\" id=\"STIM04_Ressources_URL\" name=\"STIM04_Ressources_URL\" value=\"" + strTmp + "\">")	else		jqoTmp.val(strTmp);	var jqoTmp = $("#STIM04_Ressources_App");	var strTmp = ressources.app.join("§");	if(jqoTmp.length == 0)		jqoForm.append("<input type=\"hidden\" id=\"STIM04_Ressources_App\" name=\"STIM04_Ressources_App\" value=\"" + strTmp + "\">")	else		jqoTmp.val(strTmp);	var jqoTmp = $("#STIM04_Ressources_Protocol");	var strTmp = ressources.protocol.join("§");	if(jqoTmp.length == 0)		jqoForm.append("<input type=\"hidden\" id=\"STIM04_Ressources_Protocol\" name=\"STIM04_Ressources_Protocol\" value=\"" + strTmp + "\">")	else		jqoTmp.val(strTmp);	var jqoTmp = $("#STIM04_Ressources_Status");	var strTmp = ressources.status.join("§");	if(jqoTmp.length == 0)		jqoForm.append("<input type=\"hidden\" id=\"STIM04_Ressources_Status\" name=\"STIM04_Ressources_Status\" value=\"" + strTmp + "\">")	else		jqoTmp.val(strTmp);}// Choix d'un profil d'entreprise étenduefunction STIM04_ProfilEE_OnChange() {	var strCodeEE = $("#STIM04_ProfilEE").val();	if(strCodeEE != "") {			// URL du JSON (données du profil entreprise entendue sélectionné)		var url = window.location.href;		$.ajax({			url: url.strLeft("://") + "://" + url.strRight("://").strLeft("/") + "/" + $("#ParamDB_Path").val() + "/STIMxx_ProfilEE_JSON?OpenAgent&CodeEE=" + strCodeEE,			type: 'GET', dataType: 'json', timeout: 30000,			// Echec de la requête			error: function(XMLHttpRequest, textStatus, errorThrown) {				$("#STIM04_DICT_EE").html("");				$("#STIM04_Risques_EE").html("");				$("#STIM04_ProfilEE").val("");				alert(l_Forms_Err_AJAX);			},			// Réussite de la requête			success: function(json) {				$("#STIM04_DICT_EE").html(json.DICT);				$("#STIM04_Risques_EE").html(json.Risques);			}		});	}	else {		$("#STIM04_DICT_EE").html("");		$("#STIM04_Risques_EE").html("");	}}